<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Center</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Include Quill stylesheet for rich text editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #f8f9fc;
            --accent-color: #2e59d9;
            --error-color: #e74a3b;
            --success-color: #1cc88a;
            --sidebar-width: 250px;
        }

        body {
            background-color: var(--secondary-color);
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 0;
            display: flex;
        }

        /* Mobile Header */
        .mobile-header {
            display: none;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            padding: 1rem;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .mobile-header .logo-container {
            display: flex;
            align-items: center;
        }
        
        .mobile-header .logo {
            height: 40px;
            width: auto;
            margin-right: 10px;
        }
        
        .hamburger {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            height: 100vh;
            position: fixed;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            padding: 1.5rem;
            text-align: center;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .sidebar-header .logo {
            height: auto;
            max-height: 80px;
            width: auto;
            max-width: 120px;
            object-fit: contain;
            margin-bottom: 1rem;
        }
        
        .sidebar-menu {
            padding: 1rem 0;
            height: calc(100vh - 180px);
            overflow-y: auto;
        }
        
        .nav-link {
            color: #5a5c69;
            padding: 0.75rem 1.5rem;
            margin: 0.25rem 0;
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--primary-color);
            background-color: rgba(78, 115, 223, 0.1);
            border-left: 3px solid var(--primary-color);
        }
        
        .nav-link i {
            margin-right: 0.5rem;
            width: 1.25rem;
            text-align: center;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 2rem;
            transition: all 0.3s;
            margin-top: 0;
        }
        
        /* Mobile Menu Overlay */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        /* Message Card Styles */
        .message-card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .message-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.2);
        }

        .card-header {
            background: var(--primary-color);
            padding: 1.5rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0.3) 0%,
                rgba(255, 255, 255, 0) 60%
            );
            transform: rotate(30deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: rotate(30deg) translate(-30%, -30%); }
            100% { transform: rotate(30deg) translate(30%, 30%); }
        }

        .card-body {
            padding: 2rem;
        }

        .form-control, .form-select {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d3e2;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
        }

        .btn-send {
            background-color: var(--primary-color);
            border: none;
            padding: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.05rem;
            transition: all 0.3s;
            width: 100%;
            color: white;
        }

        .btn-send:hover {
            background-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .btn-send:active {
            transform: translateY(0);
        }

        .table-hover tbody tr:hover {
            background-color: rgba(78, 115, 223, 0.05);
        }
        
        .file-upload-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .file-upload-label {
            display: block;
            padding: 1rem;
            border: 2px dashed #d1d3e2;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
        }
        
        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .file-preview {
            position: relative;
            width: 100px;
            height: 120px;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
        }
        
        .file-preview img {
            max-width: 100%;
            max-height: 70px;
            object-fit: contain;
        }
        
        .file-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .file-name {
            width: 100%;
            text-align: center;
            font-size: 0.75rem;
            word-break: break-all;
        }
        
        .remove-file {
            position: absolute;
            top: 0;
            right: 0;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .search-sort-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .alert-floating {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            min-width: 300px;
        }

        /* Quill editor customization */
        #message-editor {
            height: 250px;
            background-color: white;
            border-radius: 0.5rem;
            border: 1px solid #d1d3e2;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                z-index: 1000;
                height: 100vh;
                top: 0;
                left: 0;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .mobile-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .main-content {
                margin-left: 0;
                padding-top: 70px;
            }
        }
        
        @media (max-width: 768px) {
            .card-body {
                padding: 1.5rem;
            }
            
            .main-content {
                padding: 1rem;
                padding-top: 70px;
            }

            .search-sort-container {
                flex-direction: column;
            }
        }
        
        @media (max-width: 576px) {
            .card-body {
                padding: 1.25rem;
            }

            .form-control, .form-select {
                padding: 0.8rem;
            }
            
            .btn-send {
                width: 100%;
                padding: 0.9rem;
            }
            
            .sidebar-header .logo {
                max-height: 60px;
                max-width: 100px;
            }

            #message-editor {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="hamburger" id="hamburger">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo-container">
           
            <span class="d-none d-sm-inline">Admin Panel</span>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
           
            <h4 class="mb-0">Admin Panel</h4>
        </div>
        <div class="sidebar-menu">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('generate_receipt') }}">
                        <i class="fas fa-receipt"></i>
                        <span>Receipt Management</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('message_center') }}">
                        <i class="fas fa-envelope"></i>
                        <span>Message Center</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin_homepage') }}">
                        <i class="fas fa-home"></i>
                        <span>Edit Homepage</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="{{ url_for('admin_excel_upload') }}">
                        <i class="fas fa-upload me-2"></i>
                        <span>SDM</span>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container animate__animated animate__fadeIn">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                     <br>        <br>        
<button onclick="window.location.href='/admin'" class="back-btn" style="
    background-color: #095feb;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    width: fit-content;
    min-width: 100px;
    text-align: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="flex-shrink: 0;">
        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
    </svg>
    <span style="white-space: nowrap;">Back</span>
</button>
                    <!-- Message Form Card -->
                   
                    <!-- Message Form Card -->
<div class="card message-card">
    <div class="card-header">
        <h3 class="mb-0"><i class="fas fa-envelope me-2"></i>Message Center</h3>
    </div>
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data" id="message-form">
            <div class="mb-3">
                <label for="subject" class="form-label">Subject</label>
                <input type="text" class="form-control" id="subject" name="subject" required 
                       placeholder="Enter email subject">
            </div>
            
            <div class="mb-3">
                <label for="message" class="form-label">Message</label>
                <!-- Replace Quill with simple textarea for now -->
                <textarea class="form-control" id="message" name="message" rows="8" 
                         placeholder="Write your message here..." required></textarea>
                <!-- Hidden input for HTML content if you want to use Quill later -->
                <input type="hidden" id="html-message" name="html_message">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Recipients</label>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="recipients_type" id="all" value="all" checked>
                    <label class="form-check-label" for="all">
                        All registered participants
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="recipients_type" id="paid" value="paid">
                    <label class="form-check-label" for="paid">
                        Only paid/verified participants
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="recipients_type" id="unpaid" value="unpaid">
                    <label class="form-check-label" for="unpaid">
                        Only unpaid/unverified participants
                    </label>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Attachments (Optional)</label>
                <div class="file-upload-wrapper">
                    <label for="file-upload" class="file-upload-label">
                        <i class="fas fa-cloud-upload-alt me-2"></i>
                        Click to upload files (Max 10MB each)
                        <input type="file" id="file-upload" name="attachments" class="file-upload-input" multiple 
                               accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
                    </label>
                    <div class="file-preview-container" id="file-preview-container"></div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-send" id="send-button">
                <i class="fas fa-paper-plane me-2"></i>Send Messages
            </button>
        </form>
    </div>
</div>
                    
                    <!-- Message History Card -->
                    <div class="card message-card mt-4">
                        <div class="card-header">
                            <h3 class="mb-0"><i class="fas fa-history me-2"></i>Message History</h3>
                        </div>
                        <div class="card-body">
                            <div class="search-sort-container">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="search-input" placeholder="Search messages...">
                                </div>
                                <select class="form-select" id="sort-select">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="subject-asc">Subject (A-Z)</option>
                                    <option value="subject-desc">Subject (Z-A)</option>
                                </select>
                            </div>
                            
                            {% if email_history %}
                                <div class="table-responsive">
                                    <table class="table table-hover" id="messages-table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Subject</th>
                                                <th>Recipients</th>
                                                <th>Type</th>
                                                <th>Attachments</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for email in email_history %}
                                            <tr>
                                                <td>{{ email.timestamp|formatdate }}</td>
                                                <td>{{ email.subject }}</td>
                                                <td>
                                                    <span class="badge bg-primary rounded-pill">
                                                        {{ email.actually_sent if 'actually_sent' in email else email.total_recipients }} sent
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if email.recipients_type == 'all' %}bg-success
                                                        {% elif email.recipients_type == 'paid' %}bg-warning text-dark
                                                        {% else %}bg-secondary
                                                        {% endif %}">
                                                        {{ email.recipients_type }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if email.attachments and email.attachments|length > 0 %}
                                                        <span class="badge bg-info rounded-pill">
                                                            <i class="fas fa-paperclip me-1"></i>{{ email.attachments|length }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-light text-dark rounded-pill">
                                                            None
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="resendEmail('{{ email.id }}')">
                                                        <i class="fas fa-redo me-1"></i>Resend
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="viewMessage('{{ email.id }}')">
                                                        <i class="fas fa-eye me-1"></i>View
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No message history yet</h5>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message View Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messageModalLabel">Message Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="messageModalContent">
                    <!-- Message content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div class="modal fade" id="suggestionsModal" tabindex="-1" aria-labelledby="suggestionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="suggestionsModalLabel">User Suggestions & Feedback</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Designation</th>
                                    <th>Date</th>
                                    <th>Message</th>
                                    <th>Contact Info</th>
                                    <th>Page</th>
                                </tr>
                            </thead>
                            <tbody id="suggestionsTableBody">
                                <!-- Suggestions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noSuggestions" class="text-center py-4">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No suggestions found</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Include Quill library for rich text editor -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile sidebar toggle functionality
            const hamburger = document.getElementById('hamburger');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileMenuOverlay');
            
            // Toggle sidebar on hamburger click
            hamburger.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
            });
            
            // Close sidebar when clicking on overlay
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                overlay.style.display = 'none';
            });
            
            // Close sidebar when clicking on a nav link (for mobile)
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 992) {
                        sidebar.classList.remove('active');
                        overlay.style.display = 'none';
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 992) {
                    sidebar.classList.remove('active');
                    overlay.style.display = 'none';
                }
            });

            // Initialize Quill rich text editor
            const quill = new Quill('#message-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'image'],
                        ['clean']
                    ]
                },
                placeholder: 'Write your message here...',
            });
            
            // Update hidden input with HTML content before form submission
            document.querySelector('form').onsubmit = function() {
                document.getElementById('message').value = quill.root.innerHTML;
                return true;
            };
            
            // Show/hide date picker based on schedule option
            document.querySelectorAll('input[name="schedule_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('schedule-date-container').style.display = 
                        this.value === 'later' ? 'block' : 'none';
                });
            });

            // File upload preview functionality
            document.getElementById('file-upload').addEventListener('change', function(e) {
                const container = document.getElementById('file-preview-container');
                container.innerHTML = '';
                
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 
                                    'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                    'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
                const maxSize = 10 * 1024 * 1024; // 10MB
                
                for (const file of e.target.files) {
                    if (!allowedTypes.includes(file.type)) {
                        showAlert('danger', `File ${file.name} has invalid type`);
                        continue;
                    }
                    
                    if (file.size > maxSize) {
                        showAlert('danger', `File ${file.name} is too large (max 10MB)`);
                        continue;
                    }
                    
                    const preview = document.createElement('div');
                    preview.className = 'file-preview';
                    preview.title = `${file.name} (${formatFileSize(file.size)})`;
                    
                    const fileIcon = document.createElement('div');
                    fileIcon.className = 'file-icon';
                    
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        fileIcon.appendChild(img);
                    } else {
                        const icon = document.createElement('i');
                        icon.className = getFileIconClass(file);
                        fileIcon.appendChild(icon);
                        
                        const fileName = document.createElement('div');
                        fileName.className = 'file-name';
                        fileName.textContent = file.name.length > 15 ? 
                            file.name.substring(0, 12) + '...' : file.name;
                        preview.appendChild(fileName);
                    }
                    
                    preview.appendChild(fileIcon);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-file';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.onclick = function() {
                        container.removeChild(preview);
                        const dt = new DataTransfer();
                        for (const f of e.target.files) {
                            if (f !== file) dt.items.add(f);
                        }
                        e.target.files = dt.files;
                    };
                    
                    preview.appendChild(removeBtn);
                    container.appendChild(preview);
                }
            });
            
            function getFileIconClass(file) {
                const type = file.type;
                if (type.includes('pdf')) return 'fas fa-file-pdf text-danger';
                if (type.includes('word')) return 'fas fa-file-word text-primary';
                if (type.includes('excel')) return 'fas fa-file-excel text-success';
                return 'fas fa-file text-secondary';
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Search functionality
            document.getElementById('search-input').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#messages-table tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
            
            // Sort functionality
            document.getElementById('sort-select').addEventListener('change', function() {
                const sortValue = this.value;
                const tbody = document.querySelector('#messages-table tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                rows.sort((a, b) => {
                    const aCells = a.querySelectorAll('td');
                    const bCells = b.querySelectorAll('td');
                    
                    switch(sortValue) {
                        case 'newest':
                            return new Date(bCells[0].textContent) - new Date(aCells[0].textContent);
                        case 'oldest':
                            return new Date(aCells[0].textContent) - new Date(bCells[0].textContent);
                        case 'subject-asc':
                            return aCells[1].textContent.localeCompare(bCells[1].textContent);
                        case 'subject-desc':
                            return bCells[1].textContent.localeCompare(aCells[1].textContent);
                        default:
                            return 0;
                    }
                });
                
                rows.forEach(row => tbody.appendChild(row));
            });

           function resendEmail(emailId) {
    if(confirm('Are you sure you want to resend this email to all original recipients?')) {
        const btn = event.target;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        btn.disabled = true;
        
        fetch('/resend-email/' + emailId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                // Remove the CSRF token line
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                showAlert('success', 'Email has been queued for resending');
            } else {
                showAlert('danger', 'Error: ' + data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'Network error: ' + error);
        })
        .finally(() => {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        });
    }
}

            
            function viewMessage(emailId) {
                fetch('/get-email/' + emailId)
                    .then(response => response.json())
                    .then(data => {
                        if(data.success) {
                            const modalContent = document.getElementById('messageModalContent');
                            modalContent.innerHTML = `
                                <div class="mb-3">
                                    <h6>Subject:</h6>
                                    <p>${data.email.subject}</p>
                                </div>
                                <div class="mb-3">
                                    <h6>Sent to:</h6>
                                    <span class="badge bg-primary rounded-pill">
                                        ${data.email.actually_sent || data.email.total_recipients} recipients
                                    </span>
                                </div>
                                <div class="mb-3">
                                    <h6>Date sent:</h6>
                                    <p>${new Date(data.email.timestamp).toLocaleString()}</p>
                                </div>
                                <div class="mb-3">
                                    <h6>Message:</h6>
                                    <div class="border p-3 rounded bg-light">${data.email.message}</div>
                                </div>
                            `;
                            
                            new bootstrap.Modal(document.getElementById('messageModal')).show();
                        } else {
                            showAlert('danger', 'Error loading message');
                        }
                    })
                    .catch(error => {
                        showAlert('danger', 'Network error');
                    });
            }

            function showAlert(type, message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-floating`;
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    new bootstrap.Alert(alertDiv).close();
                }, 5000);
            }

            // Load suggestions when modal is shown
            document.getElementById('suggestionsModal').addEventListener('shown.bs.modal', function() {
                fetch('/get_suggestions')
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.getElementById('suggestionsTableBody');
                        const noSuggestions = document.getElementById('noSuggestions');
                        
                        tableBody.innerHTML = '';
                        
                        if (data.suggestions && data.suggestions.length > 0) {
                            noSuggestions.style.display = 'none';
                            
                            data.suggestions.forEach(suggestion => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${suggestion.name || 'N/A'}</td>
                                    <td>${suggestion.designation || 'N/A'}</td>
                                    <td>${new Date(suggestion.timestamp).toLocaleString()}</td>
                                    <td>${suggestion.text}</td>
                                    <td>${suggestion.contact_info || 'N/A'}</td>
                                    <td><small class="text-muted">${suggestion.page || 'N/A'}</small></td>
                                `;
                                tableBody.appendChild(row);
                            });
                        } else {
                            noSuggestions.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading suggestions:', error);
                    });
            });
        });
    </script>
</body>
</html>